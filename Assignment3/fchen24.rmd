---
title: "Homework 3"
author: "Replace with blackboard username"
output: html_document
---

Please read all instructions carefully.  Try to knit the file before final submission to catch any bugs.  To allow this file to be knit, you might need to save it in a new location, as you do not have write permissions in the dropbox folder, and R does not work well with Chinese characters.  
Some important steps: 
	1. Rename this file to your blackboard username.  This lets us grade your assignment.
	2. This assignment requires you to submit an RData file generated by this script.  See the assignment sheet and video for details on how to do this. Submissions that do not include the correct files will be penalized.
	3. Please do not create new columns in the data frame - you can include things like polynomials directly in the model formula.

```{r}
### Some simple descriptive analysis
### The comment for the analysis results are all MSE!!!!! NOT RMSE!!!!
setwd("/Users/fanfan/Documents/2022fallB/GBA436R/Assignment3")
fullFile = read.csv('Student Data 9.csv')
noReportFile = fullFile[,-which(colnames(fullFile) %in% "reports")]
library(corrplot)
corrplot(cor(model.matrix(~.-1,data = fullFile)))
anova(lm(card~.,data = fullFile))

library("earth")
plotmo(earth(card~., data = fullFile))
plotmo(earth(card~., data = fullFile, degree = 2))
anova(lm(card~., data = noReportFile))
```
```{r}
##### To calculate the accuracy of the prediction, we use rmse here
rmse <- function(modelname){
    return(mean((predict(modelname,validationData) - validationData$card)^2)**0.5)
}
```

```{r}
#### We first find out the general impact of the variables 
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,5)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = lm(card~., data = trainingData) #0.1685183
    model2 = lm(card~.^2, data = trainingData) #0.1504259
    model3 = lm(card~.^3, data = trainingData) #0.1492095 IS THE BEST!!!!
    model4 = lm(card~.^4, data = trainingData) #0.1493819
    model5 = lm(card~.^5, data = trainingData) #0.1493456
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)

    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5)
}
colMeans(modelPerformance)
```
```{r}
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,5)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = lm(card~(.-age), data = trainingData) #0.1686100
    model2 = lm(card~(.-age)^2, data = trainingData) #0.1504852
    model3 = lm(card~(.-age)^3, data = trainingData) #0.1493977
    model4 = lm(card~(.-age)^4, data = trainingData) #0.1493619
    model5 = lm(card~(.-age)^5, data = trainingData) #0.1494871
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)

    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5)
}
colMeans(modelPerformance)
```


```{r}
### We also want to find the best number of variables
library('leaps')
basicSubset = regsubsets(card~.^2,data=noReportFile, really.big = T)
basicSummary = summary(basicSubset)
bestAIC = which.min(basicSummary$cp)
bestBIC = which.min(basicSummary$bic)
coef2 = coef(basicSubset,bestBIC)
coef2

#basicSubset = regsubsets(card~(.-age-months-expenditure)^3,data=noReportFile,nvmax = 8, really.big = T)
#basicSummary = summary(basicSubset)
#bestAIC = which.min(basicSummary$cp)
#bestBIC = which.min(basicSummary$bic)
#coef3 = coef(basicSubset,bestBIC)
#coef3
```

```{r}
#### expenditure months age
#### In the first anova, we find that these three terms aren't that significant
#### Therefore, we decide to exclude them to test

set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,5)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = lm(card~.-(expenditure+months+age), data = trainingData) #0.1685921
    model2 = lm(card~(.-(expenditure+months+age))^2, data = trainingData) #0.1662551
    model3 = lm(card~(.-(expenditure+months+age))^3, data = trainingData) #0.1646722
    model4 = lm(card~income+share+expenditure+dependents+income*share + income*expenditure + share*expenditure+owner*active, data = trainingData) #0.1507336
    model5 = lm(card~share+income:majorcards+share:majorcards+share:active+dependents:majorcards+income:share:active+income:owner:active+share:dependents:majorcards, data = trainingData)#0.1666512
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5)
}
colMeans(modelPerformance)
```

```{r}
### Then, for the MARS model

library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,6)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = earth(card~., data = trainingData) #0.1501901
    model2 = earth(card~.-(expenditure+months+age), data = trainingData) #0.1511995
    model3 = earth(card~., degree = 2, data=trainingData) #0.1474591
    model4 = earth(card~., degree = 3, data = trainingData) #0.1463406
    model5 = earth(card~., degree = 4, data = trainingData) #0.1460599 BEST NOW!
    model6 = earth(card~., degree = 5, data = trainingData) #0.1460599 same as lower degree
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6)
}
colMeans(modelPerformance)

```
```{r}
library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,12)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = earth(card~.-(months+age), degree = 2, data = trainingData) #0.1474419
    model2 = earth(card~.-(months+age), degree = 3, data = trainingData) #0.1462298
    model3 = earth(card~.-(months+age),degree = 4, data = trainingData) #0.1459817
    model4 = earth(card~.-(months+age),degree = 5, data = trainingData) #0.1459817
    model5 = earth(card~.-age, degree = 2, data=trainingData) #0.1474419
    model6 = earth(card~.-age, degree = 3, data=trainingData) #0.1462298 
    model7 = earth(card~.-age, degree = 4, data=trainingData) #0.1459591 BEST NOW!
    model8 = earth(card~.-age, degree = 5, data=trainingData) #0.1459591 BEST NOW!
    model9 = earth(card~.-months, degree = 2, data=trainingData) #0.1474591
    model10 = earth(card~.-months, degree = 3, data=trainingData) #0.1463406 
    model11 = earth(card~.-months, degree = 4, data=trainingData) #0.1460825
    model12 = earth(card~.-months, degree = 5, data=trainingData) #0.1460019
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    valid8 = rmse(model8)
    valid9 = rmse(model9)
    valid10 = rmse(model10)
    valid11 = rmse(model11)
    valid12 = rmse(model12)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7, valid8, valid9, valid10, valid11, valid12)
}
colMeans(modelPerformance)

```
```{r}
##### Try nFold = 10, it's worse than nFold = 5, random for the validation maybe
library("earth")
set.seed(666)
nFold = 10
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,12)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = earth(card~.-(months+age), degree = 2, data = trainingData) #0.1474419
    model2 = earth(card~.-(months+age), degree = 3, data = trainingData) #0.1462298
    model3 = earth(card~.-(months+age),degree = 4, data = trainingData) #0.1459817
    model4 = earth(card~.-(months+age),degree = 5, data = trainingData) #0.1459817
    model5 = earth(card~.-age, degree = 2, data=trainingData) #0.1474419
    model6 = earth(card~.-age, degree = 3, data=trainingData) #0.1462298 
    model7 = earth(card~.-age, degree = 4, data=trainingData) #0.1459591 BEST NOW!
    model8 = earth(card~.-age, degree = 5, data=trainingData) #0.1459591 BEST NOW!
    model9 = earth(card~.-months, degree = 2, data=trainingData) #0.1474591
    model10 = earth(card~.-months, degree = 3, data=trainingData) #0.1463406 
    model11 = earth(card~.-months, degree = 4, data=trainingData) #0.1460825
    model12 = earth(card~.-months, degree = 5, data=trainingData) #0.1460019
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    valid8 = rmse(model8)
    valid9 = rmse(model9)
    valid10 = rmse(model10)
    valid11 = rmse(model11)
    valid12 = rmse(model12)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7, valid8, valid9, valid10, valid11, valid12)
}
colMeans(modelPerformance)
```
```{r}
#### If 75:25, it still worse than nFold = 5
library("earth")
set.seed(666)
nFold = 4
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,12)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = earth(card~.-(months+age), degree = 2, data = trainingData) #0.1474419
    model2 = earth(card~.-(months+age), degree = 3, data = trainingData) #0.1462298
    model3 = earth(card~.-(months+age),degree = 4, data = trainingData) #0.1459817
    model4 = earth(card~.-(months+age),degree = 5, data = trainingData) #0.1459817
    model5 = earth(card~.-age, degree = 2, data=trainingData) #0.1474419
    model6 = earth(card~.-age, degree = 3, data=trainingData) #0.1462298 
    model7 = earth(card~.-age, degree = 4, data=trainingData) #0.1459591 BEST NOW!
    model8 = earth(card~.-age, degree = 5, data=trainingData) #0.1459591 BEST NOW!
    model9 = earth(card~.-months, degree = 2, data=trainingData) #0.1474591
    model10 = earth(card~.-months, degree = 3, data=trainingData) #0.1463406 
    model11 = earth(card~.-months, degree = 4, data=trainingData) #0.1460825
    model12 = earth(card~.-months, degree = 5, data=trainingData) #0.1460019
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    valid8 = rmse(model8)
    valid9 = rmse(model9)
    valid10 = rmse(model10)
    valid11 = rmse(model11)
    valid12 = rmse(model12)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7, valid8, valid9, valid10, valid11, valid12)
}
colMeans(modelPerformance)
```

```{r}
library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,4)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = earth(card~.-expenditure, degree = 2, data = trainingData) #0.1464511
    model2 = earth(card~.-expenditure, degree = 3, data = trainingData) #0.1466686
    model3 = earth(card~.-expenditure,degree = 4, data = trainingData) #0.1466686
    model4 = earth(card~.-expenditure,degree = 5, data = trainingData) #0.1466686
  
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
   
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4)
}
colMeans(modelPerformance)
```


```{r}
### Degree = 3
library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,5)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = earth(card~., degree = 3, data = trainingData, thresh = 0.01) #0.1529726
    model2 = earth(card~., degree = 3, data = trainingData, thresh = 0.005) #0.1481694
    model3 = earth(card~., degree = 3, data=trainingData, thresh = 0.0001) #0.1464005
    model4 = earth(card~., degree = 3, data = trainingData, thresh = 0.05) #0.1529210
    model5 = earth(card~., degree = 3, data=trainingData, thresh = 0.001) #0.1463406
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5)
}
colMeans(modelPerformance)
```
```{r}
### Degree = 4
library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,6)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = earth(card~., degree = 4, data = trainingData, thresh = 0.01) #0.1529726
    model2 = earth(card~., degree = 4, data = trainingData, thresh = 0.005) #0.1481694
    model3 = earth(card~., degree = 4, data=trainingData, thresh = 0.0001) #0.1460599
    model4 = earth(card~., degree = 4, data = trainingData, thresh = 0.05) #0.1529210
    model5 = earth(card~., degree = 4, data=trainingData, thresh = 0.001) #0.1460599
    model6 = earth(card~., degree = 4, data=trainingData, thresh = 0.0005) #0.1460599
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6)
}
colMeans(modelPerformance)
```
```{r}
### Degree = 4
library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(noReportFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,6)
for(fold in 1:nFold){
    trainingData = subset(noReportFile, valNum!= fold)
    validationData = subset(noReportFile, valNum == fold)
    model1 = earth(card~.-age, degree = 4, data = trainingData, thresh = 0.01) #0.1529726
    model2 = earth(card~.-age, degree = 4, data = trainingData, thresh = 0.005) #0.1481694
    model3 = earth(card~.-age, degree = 4, data=trainingData, thresh = 0.0001) #0.1459591
    model4 = earth(card~.-age, degree = 4, data = trainingData, thresh = 0.05) #0.1529210
    model5 = earth(card~.-age, degree = 4, data=trainingData, thresh = 0.001) #0.1459591
    model6 = earth(card~.-age, degree = 4, data=trainingData, thresh = 0.0005) #0.1459591
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6)
}
colMeans(modelPerformance)
```

```{r}
##### To verify our finding, we do the regression by testing all of the coefficient
nFoldset = c(4,5,10)
threshset = c(0.01,0.005,0.001,0.0005,0.0001,0.00005,0.00001,0.000005,0.000001)
degreeset = c(1,2,3,4,5)

argument = c()
rmsemin = 1
for(degreenum in degreeset){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(noReportFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(noReportFile, valNum!= fold)
                validationData = subset(noReportFile, valNum == fold)
                model1 = earth(card~.,degree = degreenum, data = trainingData, thresh = threshnum)
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }

            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelfinal = model1
                print(temp)
                argument = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argument # degree = 4, thresh = 0.001, nFold = 5

for(degreenum in 2:5){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(noReportFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                
                trainingData = subset(noReportFile, valNum!= fold)
                validationData = subset(noReportFile, valNum == fold)
                model1 = lm(card~I((age+income+share+expenditure+owner+selfemp+dependents+months+majorcards+active)^degreenum), data = trainingData) 
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }
            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelfinal = model1
                print(temp)
                argument = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argument # degree = 4, thresh = 0.001, nFold = 5

```

```{r}
##### To verify our finding, we do the regression by testing all of the coefficient excluding age
nFoldset = c(4,5,10)
threshset = c(0.01,0.005,0.001,0.0005,0.0001,0.00005,0.00001,0.000005,0.000001)
degreeset = c(1,2,3,4,5)

argumentage = c()
rmsemin = 1
for(degreenum in degreeset){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(noReportFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(noReportFile, valNum!= fold)
                validationData = subset(noReportFile, valNum == fold)
                model1 = earth(card~.-age,degree = degreenum, data = trainingData, thresh = threshnum)
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }
            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelagefinal = model1
                print(temp)
                argumentage = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argumentage# degree = 4, thresh = 0.001, nFold = 5

for(degreenum in 2:5){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(noReportFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(noReportFile, valNum!= fold)
                validationData = subset(noReportFile, valNum == fold)
                model1 = lm(card~I((income+share+expenditure+owner+selfemp+dependents+months+majorcards+active)^degreenum), data = trainingData) 
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }
            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelagefinal = model1
                print(temp)
                argumentage = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argumentage# degree = 4, thresh = 0.001, nFold = 5

```

**Question 1A:**
```{r Question 1A}
#TRAIN AND ESTIMATE YOUR FIRST MODEL (WITHOUT REPORTS) HERE, starting on line 17

#Last line should store a model in model1A as below
model1A = earth(card~.-age, degree = 4, data=noReportFile)
mean((predict(model1A,noReportFile) - noReportFile$card)^2)**0.5
```

```{r}
### First, we want to find the approximate interaction degree, since we are given more info here, we need less degree of freedom to do regression and have less rmse
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,5)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = lm(card~., data = trainingData) #0.1504870
    model2 = lm(card~.^2, data = trainingData) #0.1395092 IS THE BEST!!!!
    model3 = lm(card~.^3, data = trainingData) #0.1397811
    model4 = lm(card~.^4, data = trainingData) #0.1418417
    model5 = lm(card~.^5, data = trainingData) #0.1437598
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)

    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5)
}
colMeans(modelPerformance)
```
```{r}
### Age here is also insignificant, therefore, we plan to exclude it
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,5)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = lm(card~(.-age), data = trainingData) #0.1505547
    model2 = lm(card~(.-age)^2, data = trainingData) #0.1394337
    model3 = lm(card~(.-age)^3, data = trainingData) #0.1394232 #### Best Here
    model4 = lm(card~(.-age)^4, data = trainingData) #0.1409084
    model5 = lm(card~(.-age)^5, data = trainingData) #0.1415666
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)

    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5)
}
colMeans(modelPerformance)
```
```{r}
### We also want to find the best number of variables
library('leaps')
basicSubset = regsubsets(card~.^2,data=fullFile, really.big = T)
basicSummary = summary(basicSubset)
bestAIC = which.min(basicSummary$cp)
bestBIC = which.min(basicSummary$bic)
coef2 = coef(basicSubset,bestBIC)
coef2
```


```{r}
### Then, for the MARS model

library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,5)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~., data = trainingData) #0.1379206
    model2 = earth(card~., degree = 2, data=trainingData) #0.1377066
    model3 = earth(card~., degree = 3, data = trainingData) #0.1376384 BEST NOW!
    model4 = earth(card~., degree = 4, data = trainingData) #0.1376384 same as lower degree
    model5 = earth(card~., degree = 5, data = trainingData) #0.1376384 same as lower degree
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5)
}
colMeans(modelPerformance)
```

```{r}
### When exclude age

library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,5)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~.-age, data = trainingData) #0.1379206
    model2 = earth(card~.-age, degree = 2, data=trainingData) #0.1377066
    model3 = earth(card~.-age, degree = 3, data = trainingData) #0.1376384 BEST NOW!
    model4 = earth(card~.-age, degree = 4, data = trainingData) #0.1376384 same as lower degree
    model5 = earth(card~.-age, degree = 5, data = trainingData) #0.1376384 same as lower degree
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5)
}
colMeans(modelPerformance)
```

```{r}
### Degree = 2
library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,7)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~., degree = 2, data = trainingData, thresh = 0.01) #0.1411398
    model2 = earth(card~., degree = 2, data = trainingData, thresh = 0.005) #0.1395489
    model3 = earth(card~., degree = 2, data=trainingData, thresh = 0.0001) #0.1375876 Best Here
    model4 = earth(card~., degree = 2, data = trainingData, thresh = 0.05) #0.1425378
    model5 = earth(card~., degree = 2, data=trainingData, thresh = 0.001) #0.1377066
    model6 = earth(card~., degree = 2, data=trainingData, thresh = 0.0005) #0.1375997
    model7 = earth(card~., degree = 2, data=trainingData, thresh = 0.00005) #0.1375876
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7)
}
colMeans(modelPerformance)
```

```{r}
### Degree = 3
library("earth")
set.seed(666)
nFold = 5
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,7)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~., degree = 3, data = trainingData, thresh = 0.01) #0.1411333
    model2 = earth(card~., degree = 3, data = trainingData, thresh = 0.005) #0.1394907
    model3 = earth(card~., degree = 3, data=trainingData, thresh = 0.0001) #0.1375978
    model4 = earth(card~., degree = 3, data = trainingData, thresh = 0.05) #0.1425378
    model5 = earth(card~., degree = 3, data=trainingData, thresh = 0.001) #0.1376384
    model6 = earth(card~., degree = 3, data=trainingData, thresh = 0.0005) #0.1375978
    model7 = earth(card~., degree = 3, data=trainingData, thresh = 0.00005) #0.1375978
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7)
}
colMeans(modelPerformance) # No more accurate
```
```{r}
### Nfold = 10, degree = 2
library("earth")
set.seed(666)
nFold = 10
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,7)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~., degree = 2, data = trainingData, thresh = 0.01) #0.1414742
    model2 = earth(card~., degree = 2, data = trainingData, thresh = 0.005) #0.1395215
    model3 = earth(card~., degree = 2, data=trainingData, thresh = 0.0001) #0.1374851 BEST EVER
    model4 = earth(card~., degree = 2, data = trainingData, thresh = 0.05) #0.1424681
    model5 = earth(card~., degree = 2, data=trainingData, thresh = 0.001) #0.1376870
    model6 = earth(card~., degree = 2, data=trainingData, thresh = 0.0005) #0.1375482
    model7 = earth(card~., degree = 2, data=trainingData, thresh = 0.00005) #0.1374851
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7)
}
colMeans(modelPerformance)
```
```{r}
### Nfold = 10, degree = 3
library("earth")
set.seed(666)
nFold = 10
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,7)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~., degree = 3, data = trainingData, thresh = 0.01)
    model2 = earth(card~., degree = 3, data = trainingData, thresh = 0.005)
    model3 = earth(card~., degree = 3, data=trainingData, thresh = 0.0001)
    model4 = earth(card~., degree = 3, data = trainingData, thresh = 0.05)
    model5 = earth(card~., degree = 3, data=trainingData, thresh = 0.001)
    model6 = earth(card~., degree = 3, data=trainingData, thresh = 0.0005)
    model7 = earth(card~., degree = 3, data=trainingData, thresh = 0.00005)
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7)
}
colMeans(modelPerformance) ## no more accurate here
```

```{r}
### Nfold = 4
library("earth")
set.seed(666)
nFold = 4
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,7)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~., degree = 2, data = trainingData, thresh = 0.01) #0.1413231
    model2 = earth(card~., degree = 2, data = trainingData, thresh = 0.005) #0.1397044
    model3 = earth(card~., degree = 2, data=trainingData, thresh = 0.0001) #0.1378431
    model4 = earth(card~., degree = 2, data = trainingData, thresh = 0.05) #0.1426167
    model5 = earth(card~., degree = 2, data=trainingData, thresh = 0.001) #0.1377125
    model6 = earth(card~., degree = 2, data=trainingData, thresh = 0.0005) #0.1377843
    model7 = earth(card~., degree = 2, data=trainingData, thresh = 0.00005) #0.1378431
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7)
}
colMeans(modelPerformance) ## No more accurate
```
```{r}
### Nfold = 20
library("earth")
set.seed(666)
nFold = 20
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,7)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~., degree = 2, data = trainingData, thresh = 0.01) 
    model2 = earth(card~., degree = 2, data = trainingData, thresh = 0.005)
    model3 = earth(card~., degree = 2, data=trainingData, thresh = 0.0001)
    model4 = earth(card~., degree = 2, data = trainingData, thresh = 0.05)
    model5 = earth(card~., degree = 2, data=trainingData, thresh = 0.001)
    model6 = earth(card~., degree = 2, data=trainingData, thresh = 0.0005)
    model7 = earth(card~., degree = 2, data=trainingData, thresh = 0.00005)
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7)
}
colMeans(modelPerformance) ## No more accurate
```
```{r}
### Degree = 2, variables are generated by BIC
library("earth")
set.seed(666)
nFold = 10
valNum = floor(runif(nrow(fullFile)) * nFold)+1
modelPerformance = matrix(NA,nFold,7)
for(fold in 1:nFold){
    trainingData = subset(fullFile, valNum!= fold)
    validationData = subset(fullFile, valNum == fold)
    model1 = earth(card~(reports+income+share+expenditure+dependents+active+income*share+share*expenditure), degree = 2, data = trainingData, thresh = 0.01) 
    model2 = earth(card~(reports+income+share+expenditure+dependents+active+income*share+share*expenditure), degree = 2, data = trainingData, thresh = 0.005) 
    model3 = earth(card~(reports+income+share+expenditure+dependents+active+income*share+share*expenditure), degree = 2, data=trainingData, thresh = 0.0001)
    model4 = earth(card~(reports+income+share+expenditure+dependents+active+income*share+share*expenditure), degree = 2, data = trainingData, thresh = 0.05)
    model5 = earth(card~(reports+income+share+expenditure+dependents+active+income*share+share*expenditure), degree = 2, data=trainingData, thresh = 0.001) 
    model6 = earth(card~(reports+income+share+expenditure+dependents+active+income*share+share*expenditure), degree = 2, data=trainingData, thresh = 0.0005) 
    model7 = earth(card~(reports+income+share+expenditure+dependents+active+income*share+share*expenditure), degree = 2, data=trainingData, thresh = 0.00005) 
    valid1 = rmse(model1) 
    valid2 = rmse(model2)
    valid3 = rmse(model3)
    valid4 = rmse(model4)
    valid5 = rmse(model5)
    valid6 = rmse(model6)
    valid7 = rmse(model7)
    modelPerformance[fold, ] = c(valid1, valid2, valid3, valid4, valid5, valid6, valid7)
}
colMeans(modelPerformance) # No more accurate
```

```{r}
##### To verify our finding, we do the regression by testing all of the coefficient
nFoldset = c(4,5,10)
threshset = c(0.01,0.005,0.001,0.0005,0.0001,0.00005,0.00001,0.000005,0.000001)
degreeset = c(1,2,3,4,5)

argumentfull = c()
rmsemin = 1
for(degreenum in degreeset){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(fullFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(fullFile, valNum!= fold)
                validationData = subset(fullFile, valNum == fold)
                model1 = earth(card~.,degree = degreenum, data = trainingData, thresh = threshnum)
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }

            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelfullfinal = model1
                print(rmsemin)
                argumentfull = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argumentfull# degree = 2, thresh = 0.0001, nFold = 10

for(degreenum in 2:5){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(fullFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(fullFile, valNum!= fold)
                validationData = subset(fullFile, valNum == fold)
                model1 = lm(card~I((age+income+share+expenditure+owner+selfemp+dependents+months+majorcards+active)^degreenum), data = trainingData) 
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }
            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelfullfinal = model1
                print(temp)
                argumentfull = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argumentfull# degree = 2, thresh = 0.0001, nFold = 10

```

```{r}
##### To verify our finding, we do the regression by testing all of the coefficient
nFoldset = c(4,5,10)
threshset = c(0.01,0.005,0.001,0.0005,0.0001,0.00005,0.00001,0.000005,0.000001)
degreeset = c(1,2,3,4,5)

argumentfull = c()
rmsemin = 1
for(degreenum in degreeset){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(fullFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(fullFile, valNum!= fold)
                validationData = subset(fullFile, valNum == fold)
                model1 = earth(card~.-months,degree = degreenum, data = trainingData, thresh = threshnum)
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }

            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelfullfinal = model1
                print(rmsemin)
                argumentfull = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argumentfull# degree = 2, thresh = 0.0001, nFold = 10

for(degreenum in 2:5){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(fullFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(fullFile, valNum!= fold)
                validationData = subset(fullFile, valNum == fold)
                model1 = lm(card~I((age+income+share+expenditure+owner+selfemp+dependents+months+majorcards+active)^degreenum), data = trainingData) 
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }
            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelfullfinal = model1
                print(temp)
                argumentfull = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argumentfull# degree = 2, thresh = 0.0001, nFold = 10

```

```{r}
##### To verify our finding, we do the regression by testing all of the coefficient
nFoldset = c(4,5,10)
threshset = c(0.01,0.005,0.001,0.0005,0.0001,0.00005,0.00001,0.000005,0.000001)
degreeset = c(1,2,3,4,5)

argumentfull = c()
rmsemin = 1
for(degreenum in degreeset){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(fullFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(fullFile, valNum!= fold)
                validationData = subset(fullFile, valNum == fold)
                model1 = earth(card~.-months-age,degree = degreenum, data = trainingData, thresh = threshnum)
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }

            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelfullfinal = model1
                print(rmsemin)
                argumentfull = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argumentfull# degree = 2, thresh = 0.0001, nFold = 10

for(degreenum in 2:5){
    for(nFold in nFoldset){
        for(threshnum in threshset){
            set.seed(666)
            valNum = floor(runif(nrow(fullFile)) * nFold)+1
            modelPerformance = matrix(NA,nFold,1)
            for(fold in 1:nFold){
                trainingData = subset(fullFile, valNum!= fold)
                validationData = subset(fullFile, valNum == fold)
                model1 = lm(card~I((income+share+expenditure+owner+selfemp+dependents+majorcards+active)^degreenum), data = trainingData) 
                valid1 = rmse(model1) 
                modelPerformance[fold, ] = c(valid1)
            }
            temp = colMeans(modelPerformance)[1]
            if(temp < rmsemin){
                rmsemin = temp
                modelfullfinal = model1
                print(temp)
                argumentfull = c(degreenum,threshnum,nFold)
            }
        }
    }
}
argumentfull# degree = 2, thresh = 0.0001, nFold = 10

```

**Question 1B:**
```{r Question 1B}
#TRAIN AND ESTIMATE YOUR SECOND MODEL (WITH REPORTS) HERE, starting on line 30

#Last line should store a model in model1B as below
model1B = earth(card~., degree = 2, data=fullFile, thresh = 0.0001)
mean((predict(model1B,fullFile) - fullFile$card)^2)**0.5
```


```{r, quietly=FALSE,warning=FALSE,echo=FALSE,results=TRUE}
#The following code checks if you generated the models correctly.  Run it, and if you don't see any of the error messages below. Do not alter it any way - not even to change the variable names.  If not, please correct, or contact the TAs for help 


#This reduces the file size in some cases fringe cases
model1A$cv.list = NULL
model1A$cv.oof.fit.tab = NULL
model1A$varmod = NULL

model1B$cv.list = NULL
model1B$cv.oof.fit.tab = NULL
model1B$varmod = NULL

isError = FALSE

if(!(class(model1A)=='earth'|class(model1A)=='lm')){
	print('model1A is not an earth or lm model.  Be sure to submit a statistical model here.')
  isError = TRUE}
	
if(!(class(model1B)=='earth'|class(model1B)=='lm')){
	print('model1B is not an earth or lm model.  Be sure to submit a statistical model here.')
  isError = TRUE}


if(class(model1A)=='earth'){
	noReport = !(grepl('reports',paste(rownames(model1A$coefficients),collapse=' ')))
}  else {
	noReport = !(grepl('reports',paste(names(model1A$coefficients),collapse=' ')))
}

if(!noReport){
	print('Make sure you do not use the report variable in model1A')
  isError = TRUE
}

if(!isError){
  save(model1A, model1B, file = 'MyModels.Rdata')
  print('MyModels.Rdata generated!  Please submit this file via blackboard.')
} else {
  print('Your code does not produce the right output.  Please correct your code, or get in touch with the TA.')
}

```